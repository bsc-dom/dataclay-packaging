version: 2.6.dev.build{build}
build_cloud: bsccsdomci01
branches:
  only:
    - develop
skip_tags: true
skip_branch_with_pr: true
image: Ubuntu1804
max_jobs: 1
environment:
  MN_SALT:
    secure: y0lD3CmSDZQx7zsNkyqUQyFtiV2eoewZ94bxSk9yoUrc6Mfgto18k7hzAitfVxs124Pai3GGvBpDZppuXikFPQ==
  MN_SECRET:
    secure: +ZRoLZnCowoJI/RvYao/XzgDz4usFDcZRX5aRoTBHUY=
deploy_script:
  - |
    echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    docker run -v $APPVEYOR_BUILD_FOLDER:$APPVEYOR_BUILD_FOLDER \
          -v ${HOME}/.docker/config.json:/root/.docker/config.json:ro \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -e MN_SALT=$MN_SALT \
          -e MN_SECRET=$MN_SECRET \
          -w=$APPVEYOR_BUILD_FOLDER \
          bscdataclay/continuous-integration:packaging-mn \
          ./hpc/mn/deploy.sh
    EXIT_CODE=$?
    docker logout
    exit $EXIT_CODE
notifications:
  - provider: Email
    to:
      - dgasull@bsc.es
    on_build_success: false
    on_build_failure: true
    on_build_status_changed: true